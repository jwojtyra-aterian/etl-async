#!/usr/bin/env php
<?php

use Flow\ETL\Async\ReactPHP\Worker\TCPClient;
use Flow\Serializer\CompressingSerializer;
use Flow\Serializer\NativePHPSerializer;
use Monolog\Handler\StreamHandler;
use Monolog\Logger;
use Symfony\Component\Console\Application;
use Flow\ETL\Async\Symfony\Worker\WorkerCommand;

(function () {
    \error_reporting(E_ALL);
    \ini_set('display_errors', 'stderr');

    if (is_file($autoload = getcwd() . '/vendor/autoload.php')) {
        require $autoload;
    } elseif (is_file($autoload = getcwd() . '/../../autoload.php')) {
        require $autoload;
    } elseif (is_file($autoload = __DIR__ . '/../vendor/autoload.php')) {
        require($autoload);
    } elseif (is_file($autoload = __DIR__ . '/../../../autoload.php')) {
        require($autoload);
    } else {
        fwrite(STDERR,
            'You must set up the project dependencies, run the following commands:' . PHP_EOL .
            'curl -s http://getcomposer.org/installer | php' . PHP_EOL .
            'php composer.phar install' . PHP_EOL
        );
        exit(1);
    }

    $logger = new Logger('client');
    $logger->pushHandler(new StreamHandler(__DIR__ . '/../var/logs/client_' . getmypid() .'.log', Logger::DEBUG));
    $logger->pushHandler(new StreamHandler(__DIR__ . '/../var/logs/client_error_' . getmypid() .'.log', Logger::ERROR, false));

//    $logger = new \Psr\Log\NullLogger();

    try {
        $serializer = new CompressingSerializer(new NativePHPSerializer());
        $application = new Application();

        $command = new WorkerCommand(
            $logger,
            new TCPClient($logger, $serializer)
        );

        $application->add($command);
        $application->setDefaultCommand($command->getName(), true);
        $application->run();
    } catch (\Throwable $e) {
        $logger->error('[worker] worker exception: ' . $e->getMessage(), [
            'exception' => $e
        ]);
    }
})();